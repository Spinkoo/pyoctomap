# ROS-compatible Dockerfile for building pyoctomap wheels
FROM quay.io/pypa/manylinux_2_28_x86_64:2025.09.19-1 AS builder

# Install build dependencies including ROS-compatible libraries
RUN echo "ğŸ”§ Installing build dependencies for ROS compatibility..." && \
    yum install -y cmake3 make gcc gcc-c++ git && \
    yum clean all && \
    echo "âœ… Build dependencies installed!"

# Copy source code
COPY . /project
WORKDIR /project

# Build OctoMap C++ library with ROS-compatible flags
RUN echo "ğŸ—ï¸ Building OctoMap C++ library with ROS compatibility..." && \
    cd src/octomap && \
    mkdir -p build && \
    cd build && \
    echo "ğŸ”¨ Configuring CMake with ROS-compatible flags..." && \
    cmake3 .. -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_CXX_STANDARD=17 \
              -DCMAKE_POSITION_INDEPENDENT_CODE=ON && \
    echo "âš™ï¸ Compiling OctoMap library..." && \
    make -j$(nproc) && \
    echo "ğŸ“¦ Installing OctoMap library..." && \
    make install && \
    ldconfig && \
    echo "âœ… OctoMap C++ library built successfully!"

# Copy libraries to the expected location
RUN echo "ğŸ“š Copying OctoMap libraries for bundling..." && \
    mkdir -p src/octomap/lib && \
    find /usr/local/lib -name "*.so*" -exec cp {} src/octomap/lib/ \; && \
    find /usr/local/lib -name "*.a" -exec cp {} src/octomap/lib/ \; && \
    echo "ğŸ“‹ Libraries copied to src/octomap/lib/:" && \
    ls -la src/octomap/lib/ && \
    echo "âœ… Libraries ready for wheel bundling!"

# Build wheel for ROS integration (Python 3.11 only for faster testing)
RUN echo "ğŸš€ Starting ROS-compatible wheel build..." && \
    echo "ğŸ Building for Python 3.11 (ROS compatible)..." && \
    /opt/python/cp311-cp311/bin/pip install --upgrade pip setuptools wheel && \
    /opt/python/cp311-cp311/bin/pip install numpy cython && \
    echo "ğŸ”¨ Building pyoctomap wheel (ROS dependencies installed separately)..." && \
    /opt/python/cp311-cp311/bin/python setup.py bdist_wheel && \
    echo "âœ… ROS-compatible wheel build completed!"

# Show what libraries are in the wheels before repair
RUN echo "ğŸ” Checking libraries in wheels before repair:" && \
    for wheel in dist/*.whl; do \
        echo "=== $wheel ===" && \
        unzip -l "$wheel" | grep -E "\.(so|a)$" || echo "No libraries found"; \
    done

# Install auditwheel
RUN echo "ğŸ”§ Installing auditwheel for manylinux compatibility..." && \
    /opt/python/cp311-cp311/bin/pip install auditwheel && \
    echo "âœ… auditwheel installed!"

# Copy libraries to standard location for auditwheel
RUN echo "ğŸ“š Preparing libraries for auditwheel repair..." && \
    cp src/octomap/lib/*.so* /usr/local/lib/ && \
    ldconfig && \
    echo "âœ… Libraries ready for auditwheel!"

# Repair all wheels for manylinux compatibility
RUN echo "ğŸ› ï¸ Repairing wheels for manylinux compatibility..." && \
    for wheel in dist/*.whl; do \
        echo "ğŸ”¨ Repairing $wheel..." && \
        /opt/python/cp311-cp311/bin/auditwheel repair "$wheel" -w dist/ --plat manylinux_2_28_x86_64; \
    done && \
    echo "âœ… Wheel repair completed!"

# Show final wheels
RUN echo "ğŸ‰ Final ROS-compatible wheels:" && \
    ls -la dist/ && \
    echo "ğŸ“Š Wheel details:" && \
    for wheel in dist/*.whl; do \
        echo "=== $wheel ===" && \
        /opt/python/cp311-cp311/bin/auditwheel show "$wheel" || echo "auditwheel show failed"; \
    done

# Final stage - just copy the built wheels
FROM alpine:latest
RUN apk add --no-cache bash
COPY --from=builder /project/dist/*.whl /wheels/
WORKDIR /wheels
RUN echo "ğŸ‰ ROS-compatible pyoctomap wheels ready!" && \
    echo "ğŸ“¦ Available wheels:" && \
    ls -la
CMD ["echo", "ğŸš€ ROS-compatible pyoctomap wheels built successfully!"]
